<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <title>Reading List</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.3/js/tether.min.js"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>

<style type="text/css">
  .entry-form{
    padding:40px;
    border:1px solid #ddd;
    border-radius:5px;
    background-color:#fcfdfd;
    margin:0 auto;
    margin-top: 40px;
  }

  .entry-form .form-success{
    padding:15px;
  }

  @media screen and (min-width: 740px){
    .entry-form{
      width:50%;
    }
  }

  .hidden{
    display:none;
  }
</style>
</head>

<body>
  <script>
  //Create issue form handler
  window.addEventListener("load", function() {

    const entryForm = document.getElementById('needs-validation');
    //Form event listener on Submit
    entryForm.addEventListener("submit", function(event) {
      const mainUrl = this.querySelector('#url').value;
      const tok = this.querySelector('#token').value;
      if (!entryForm.checkValidity()) {
        event.preventDefault();

      } else {
        event.preventDefault();

        //Calls function that will handle GitHub API connection
        httpConnect(this, tok);
        entryForm.classList.add("was-validated");
      }

    }, false)
  }, false)

  //Connects to GitHub API and posts the object with form values
  function httpConnect(form, tok) {
    const entry = createIssueObj(form);
    const httpRequest = new XMLHttpRequest();
    const successMessage = document.querySelector('.form-success')

    if (!httpRequest) {
      return false;
    }

    httpRequest.onreadystatechange = createGitIssue;
    httpRequest.open('POST', 'https://api.github.com/repos/gkiar/reading/issues?access_token='+ tok); // ###'); //Replace '###' with GitHub Personal Token
    httpRequest.setRequestHeader('Accept', 'application/vnd.github.v3.raw+json');
    httpRequest.send(JSON.stringify(entry));

    function createGitIssue() {
      if (httpRequest.readyState === XMLHttpRequest.DONE) {
        if (httpRequest.status === 201) {
          form.reset();
          document.getElementById("issuelink").href = JSON.parse(httpRequest.response).html_url;
          successMessage.classList.remove("hidden");
        } else {
          alert('There was a problem sending the form.');
        }
      }
    }
  }

  //Gets values from the form and creates an Object with them
  function createIssueObj(form) {
    var issueObj = {},
      paper = form.querySelector('#paper-name'),
      doesText = form.querySelector('#does'),
      doesntText = form.querySelector('#doesnt'),
      notes = form.querySelector('#notes'),
      url = form.querySelector('#url'),
      taglist_ = form.querySelector('#tags')

      taglist = []
      for (var i=0; i < taglist_.selectedOptions.length; i++) {
         taglist = taglist.concat(taglist_.selectedOptions[i].label)
      }

    issueObj.title = "Paper: " + paper.value;
    issueObj.body = "URL: ["+ url.value +"](" + url.value + ") \n" +
                    "## This paper does... \n\n" + doesText.value + "\n" +
                    "## This paper does not... \n\n" + doesntText.value + "\n" +
                    "## Other comments? \n\n" + notes.value + "\n";
    issueObj.labels = taglist
    console.log(issueObj)
    return issueObj;
  }
</script>
 <div id="mainform">
   <h3>Paper Index</h3>
   <p><em>Psst! Bookmark <a href="javascript: (function () {var jsCode = document.createElement('script');jsCode.setAttribute('src', 'http://gkiar.github.io/reading/bookmarklet.js');document.body.appendChild(jsCode);}());">this link</a> to load this page as an overlay, anywhere!</em></p>
   <p><em>Psst! Bookmark <a href="javascript: (function () {var jsCode = document.createElement('script');jsCode.setAttribute('src', './bookmarklet.js');document.body.appendChild(jsCode);}());">this link</a> to load this page as an overlay, anywhere!</em></p>
   <p class="form-success bg-success hidden">Form submitted successfully! See your notes <a id="issuelink" target="_blank" href="#">here</a>.</p>
   <form id="needs-validation">
      <div class="form-group">
         <label for="paper-name">Paper title</label>
         <input type="text" class="form-control" id="paper-name" placeholder="Title or shorthand identifier" required>
      </div>
      <div class="form-group">
         <label for="mainurl">URL *</label>
         <input type="url" class="form-control" id="url" placeholder="Link to paper or citation" required>
      </div>
      <div class="form-group">
         <label for="token">API Token</label>
         <input type="text" class="form-control" id="token" placeholder="OAuth Github API token" required>
      </div>
      <div class="form-group">
         <label for="does">This paper does...</label>
         <input type="text" class="form-control" id="does" placeholder="... state/claim/demonstrate/produce/etc...">
      </div>
      <div class="form-group">
         <label for="doesnt">This paper does not...</label>
         <input type="text" class="form-control" id="doesnt" placeholder="... address/consider/apply to/etc...">
      </div>
      <div class="form-group">
         <label for="notes">Additional notes?</label>
         <input type="text" class="form-control" id="notes" placeholder="Extra noteworthy details">
      </div>
      <div class="form-group">
         <label for="tags">Tags</label>
          <div>
         <select class="form-group selectpicker" id="tags" multiple>
           <option>to read</option>
           <option>stats</option>
           <option>imaging</option>
           <option>neuroscience</option>
           <option>processing</option>
           <option>data/metadata</option>
           <option>reproducibility</option>
         </select>
          </div>
      </div>
      <button type="submit" class="btn btn-info">Index Reference</button>
   </form>
  </div>
</body>
</html>
